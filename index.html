<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Barcode & QR Code Scanner</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
    }
    #video {
      width: 100%;
      max-width: 400px;
      display: none;
      margin: 10px auto;
    }
    #message {
      margin-top: 10px;
      font-size: 18px;
      color: green;
    }
    #scanButton, #forceScanButton {
      padding: 10px 20px;
      font-size: 16px;
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 5px;
      margin-top: 10px;
    }
    #scanButton:disabled, #forceScanButton:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
    }
    #forceScanButton {
      display: none;
    }
    #consoleOutput {
      font-size: 14px;
      background: #f0f0f0;
      color: #333;
      padding: 10px;
      margin-top: 10px;
      white-space: pre-wrap;
      border: 1px solid #ccc;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <h1>Scan to create your fighter!</h1>
  <button id="scanButton">Click to Scan Barcode or QR Code</button>
  <button id="forceScanButton">Force Scan</button>
  <video id="video" autoplay></video>
  <div id="message"></div>

  <!-- Console Output Section -->
  <div id="consoleOutput"></div>

  <!-- Updated with version number to bust cache -->
  <script src="https://unpkg.com/@zxing/library@0.18.6/dist/index.min.js?v=1.02"></script>

  <script>
    const video = document.getElementById("video");
    const scanButton = document.getElementById("scanButton");
    const forceScanButton = document.getElementById("forceScanButton");
    const message = document.getElementById("message");
    const consoleOutput = document.getElementById("consoleOutput");

    let barcodeScanned = false;
    let selectedDeviceId;

    const codeReader = new ZXing.BrowserBarcodeReader();

    // Print logs to the consoleOutput element
    function logToConsole(message) {
      consoleOutput.textContent += message + "\n";
      console.log(message); // Also log to the browser console for debugging
    }

    // Start scanning when the button is clicked
    scanButton.addEventListener("click", () => {
      logToConsole("Scan button clicked."); // Log when the button is clicked

      // Reset previous scan state
      barcodeScanned = false;
      message.textContent = "";

      // Show video and start scanning
      video.style.display = "block";
      scanButton.style.display = "none"; // Hide the button
      forceScanButton.style.display = "inline-block"; // Show force scan button
      scanButton.disabled = true;

      // Get the available video devices (cameras)
      ZXing.BrowserCodeReader.listVideoDevices().then((videoInputDevices) => {
        logToConsole("Available video devices: " + JSON.stringify(videoInputDevices));
        if (videoInputDevices.length > 0) {
          selectedDeviceId = videoInputDevices[0].deviceId; // Choose the first camera
          startScanning();
        } else {
          message.textContent = "No camera devices found.";
          logToConsole("No camera devices found.");
        }
      }).catch((error) => {
        logToConsole("Error accessing video devices: " + error);
        message.textContent = "Error accessing camera.";
      });
    });

    // Start scanning function
    function startScanning() {
      logToConsole("Starting scan...");
      codeReader
        .decodeFromVideoDevice(selectedDeviceId, video, (result, error) => {
          if (result && !barcodeScanned) {
            barcodeScanned = true; // Stop further scanning
            codeReader.reset(); // Stop the scanner
            video.style.display = "none"; // Hide the video feed
            scanButton.style.display = "inline-block"; // Show the button again
            forceScanButton.style.display = "none"; // Hide the force scan button
            scanButton.disabled = false; // Re-enable the button
            message.textContent = `Scan Success: ${result.text} (Type: ${result.format})`;
            logToConsole(`Scan Success: ${result.text} (Type: ${result.format})`);
          }

          if (error && !barcodeScanned) {
            message.textContent = "Scanning error or no barcode/QR code detected!";
            logToConsole("Error during scan: " + error);
          }
        })
        .catch((err) => {
          logToConsole("Error starting scanning: " + err);
          message.textContent = "Error accessing the camera.";
        });
    }

    // Force scan button to manually capture image and stop scanning
    forceScanButton.addEventListener("click", () => {
      logToConsole("Force scan button clicked.");
      codeReader.reset(); // Manually stop scanning
      message.textContent = "Scan process was manually stopped.";
      video.style.display = "none"; // Hide the video feed
      scanButton.style.display = "inline-block"; // Show the button again
      forceScanButton.style.display = "none"; // Hide the force scan button
    });

    // Cleanup when the page is closed
    window.addEventListener("beforeunload", () => {
      codeReader.reset();
    });
  </script>
</body>
</html>
