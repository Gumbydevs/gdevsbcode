<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Barcode Scanner</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
    }
    #video {
      width: 100%;
      max-width: 400px;
      display: none;
      margin: 10px auto;
    }
    #message {
      margin-top: 10px;
      font-size: 18px;
      color: green;
    }
    #scanButton {
      padding: 10px 20px;
      font-size: 16px;
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 5px;
    }
    #scanButton:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <h1>Barcode Scanner</h1>
  <button id="scanButton">Click to Scan Barcode</button>
  <video id="video" autoplay></video>
  <div id="message"></div>

  <script>
    // Cache-busting version query
    const scriptVersion = 'v=1.0.1'; // Update version as needed
    
    // Dynamically load the script with cache busting
    const script = document.createElement('script');
    script.type = 'module';
    script.src = `https://cdn.jsdelivr.net/npm/qr-scanner/qr-scanner.min.js?${scriptVersion}`;
    document.head.appendChild(script);

    script.onload = () => {
      const video = document.getElementById("video");
      const scanButton = document.getElementById("scanButton");
      const message = document.getElementById("message");

      let qrScanner;
      let barcodeScanned = false;

      scanButton.addEventListener("click", () => {
        // Reset previous scan state
        barcodeScanned = false;
        message.textContent = "";

        // Show video and start scanning
        video.style.display = "block";
        scanButton.style.display = "none"; // Hide the button when scanning starts
        scanButton.disabled = true;

        // Initialize QR Scanner
        qrScanner = new QrScanner(
          video,
          (result) => {
            if (!barcodeScanned) {
              barcodeScanned = true; // Stop further scanning
              qrScanner.stop(); // Stop the scanner
              video.style.display = "none"; // Hide the video feed
              scanButton.style.display = "inline-block"; // Show the button again
              scanButton.disabled = false; // Re-enable the button
              message.textContent = `Barcode Scanned: ${result}`;
            }
          },
          {
            highlightScanRegion: true,
          }
        );

        qrScanner.start();
      });

      // Cleanup when the page is closed
      window.addEventListener("beforeunload", () => {
        if (qrScanner) {
          qrScanner.destroy();
        }
      });
    };
  </script>
</body>
</html>
