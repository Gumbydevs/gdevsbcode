<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Barcode Scanner - Version 1.018</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
    #video { width: 100%; max-width: 400px; display: none; margin-top: 10px; }
    .buttons { margin-top: 20px; }
    .button { margin: 5px; padding: 10px; font-size: 16px; cursor: pointer; }
    #monsterInfo { margin-top: 20px; }
    .popup { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 20px; background: white; border: 1px solid #ccc; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
    .popup button { margin: 10px; padding: 10px; font-size: 14px; }
  </style>
</head>
<body>
  <h1>Barcode Scanner</h1>
  <button id="scanButton">Click to Scan Barcode</button>
  <button id="forceScanButton" style="display: none;">Force Scan</button>
  <video id="video" autoplay></video>
  <div id="message"></div>

  <!-- Monster Info section -->
  <div id="monsterInfo"></div>

  <!-- Popup for saving monster -->
  <div id="savePopup" class="popup">
    <p id="popupMessage"></p>
    <button id="saveButton">Save to Collection</button>
    <button id="cancelButton">Cancel</button>
  </div>

  <!-- Buttons Section for other game areas -->
  <div class="buttons">
    <button class="button" onclick="window.location.href='monster-collection.html'">Fighter Collection</button>
    <button class="button" onclick="window.location.href='monster-training.html'">Monster Training</button>
    <button class="button" onclick="window.location.href='pvp-battle.html'">PVP Battle</button>
    <button class="button" onclick="window.location.href='help.html'">Help</button>
    <button class="button" onclick="window.location.href='index.html'">Main Page</button>
  </div>

  <div id="consoleOutput"></div>
  <div id="version">Version 1.018</div>
  <div style="font-size: 12px; color: gray; margin-top: 20px;">&copy; 2025 Barcode Masters. All rights reserved.</div>

  <script type="module">
    import QrScanner from "https://cdn.jsdelivr.net/npm/qr-scanner/qr-scanner.min.js?v=1.018";

    const video = document.getElementById("video");
    const scanButton = document.getElementById("scanButton");
    const forceScanButton = document.getElementById("forceScanButton");
    const message = document.getElementById("message");
    const consoleOutput = document.getElementById("consoleOutput");
    const monsterInfo = document.getElementById("monsterInfo");
    const savePopup = document.getElementById("savePopup");
    const popupMessage = document.getElementById("popupMessage");
    const saveButton = document.getElementById("saveButton");
    const cancelButton = document.getElementById("cancelButton");

    let qrScanner;
    let barcodeScanned = false;

    // Retrieve player data from localStorage or set defaults
    let player = JSON.parse(localStorage.getItem('player')) || {
      id: 'player1',
      monsterCollection: []
    };

    // Debug logging function
    function logToConsole(msg) {
      const logMessage = document.createElement('div');
      logMessage.textContent = msg;
      consoleOutput.appendChild(logMessage);
      console.log(msg);
    }

    // Generate random monster data
    function generateMonsterData(barcodeData) {
      const names = ["Gorgoth", "Slithor", "Zarvok", "Magrath", "Korrak", "Zypheron"];
      const monsterId = "MONSTER-" + barcodeData.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
      const name = names[Math.floor(Math.random() * names.length)];
      const level = Math.random() < 0.1 ? Math.floor(Math.random() * 3) + 2 : 1;
      const stats = {
        HP: Math.floor(Math.random() * 100) + 50,
        AP: Math.floor(Math.random() * 20) + 10,
        Speed: Math.floor(Math.random() * 10) + 5
      };
      if (level > 1) {
        stats.HP = Math.floor(stats.HP * (1 + 0.2 * level));
        stats.AP = Math.floor(stats.AP * (1 + 0.2 * level));
        stats.Speed = Math.floor(stats.Speed * (1 + 0.2 * level));
      }

      return { id: monsterId, name, level, stats };
    }

    // Add monster to collection
    function addMonsterToCollection(monster) {
      player.monsterCollection.push(monster);
      localStorage.setItem('player', JSON.stringify(player));
      logToConsole(`Monster added: ${monster.name}`);
    }

    // Display popup to save monster
    function showSavePopup(monster) {
      popupMessage.textContent = `Add ${monster.name} (Level ${monster.level}) to your collection?`;
      savePopup.style.display = "block";

      saveButton.onclick = () => {
        addMonsterToCollection(monster);
        savePopup.style.display = "none";
        alert(`${monster.name} has been added to your collection!`);
      };

      cancelButton.onclick = () => {
        savePopup.style.display = "none";
      };
    }

    // Start scanning
    scanButton.addEventListener("click", async () => {
      barcodeScanned = false;
      video.style.display = "block";
      scanButton.style.display = "none";
      forceScanButton.style.display = "inline-block";

      qrScanner = new QrScanner(video, (result) => {
        if (!barcodeScanned) {
          barcodeScanned = true;
          const monster = generateMonsterData(result.data);
          monsterInfo.innerHTML = `
            <div>Monster ID: ${monster.id}</div>
            <div>Name: ${monster.name}</div>
            <div>Level: ${monster.level}</div>
            <div>HP: ${monster.stats.HP}</div>
            <div>AP: ${monster.stats.AP}</div>
            <div>Speed: ${monster.stats.Speed}</div>
          `;
          qrScanner.stop();
          video.style.display = "none";
          scanButton.style.display = "inline-block";
          forceScanButton.style.display = "none";
          showSavePopup(monster);
        }
      });

      await qrScanner.start();
      logToConsole("Scanner started...");
    });

    // Cleanup on unload
    window.addEventListener("beforeunload", () => {
      if (qrScanner) qrScanner.destroy();
    });
  </script>
</body>
</html>
